<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="container">
    <header class="page-header dataset-header">
        <div class="dataset-heading">
            <a href="/datasets" class="back-link">‚Üê Back</a>
            <h1 id="datasetTitle">Dataset</h1>
            <p id="datasetDescription" class="field-hint"></p>
        </div>
    </header>

    <section class="card pipeline-card" id="pipelineCard">
        <div class="card-header">
            <div>
                <h2>Pipeline</h2>
                <p class="field-hint">Configure sources ‚Üí Mapping editor ‚Üí Transformation ‚Üí Export dataset.</p>
            </div>
        </div>
        <div class="pipeline-frame">
            <div class="pipeline-context">Follow the numbered stages. Each "Next" action kicks off the required processing.</div>
            <div class="pipeline-steps" id="pipelineSteps">
                <div class="pipeline-step" data-step="sources">
                    <div class="step-index">1</div>
                    <div class="step-body">
                        <p class="step-title">Configure sources</p>
                        <p class="field-hint">Add or assign sources. Click Next to begin ingestion.</p>
                        <p id="ingestionStepStatus" class="field-hint step-hint"></p>
                    </div>
                </div>
                <div class="pipeline-connector">‚Üí</div>
                <div class="pipeline-step" data-step="mappings">
                    <div class="step-index">2</div>
                    <div class="step-body">
                        <p class="step-title">Mapping editor</p>
                        <p class="field-hint">Define mappings here, then click Next to run transformation.</p>
                        <p id="mappingStepStatus" class="field-hint step-hint"></p>
                    </div>
                </div>
                <div class="pipeline-connector">‚Üí</div>
                <div class="pipeline-step" data-step="transform">
                    <div class="step-index">3</div>
                    <div class="step-body">
                        <p class="step-title">Transformation</p>
                        <p class="field-hint">We turn raw rows into unified data right after you run Next.</p>
                        <p id="transformStepStatus" class="field-hint step-hint"></p>
                    </div>
                </div>
                <div class="pipeline-connector">‚Üí</div>
                <div class="pipeline-step" data-step="export">
                    <div class="step-index">4</div>
                    <div class="step-body">
                        <p class="step-title">Export dataset</p>
                        <p class="field-hint">Review the unified table and export CSV.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="card stage-section visible" data-stage-section="sources" id="sourcesStage">
        <div class="card-header">
            <div>
                <h2>Stage 1 ‚Äî Configure sources</h2>
                <p class="field-hint">Add or assign sources, then click Next to ingest. This stage uses the full width for sources.</p>
            </div>
            <div class="table-actions">
                <button id="openAddSourceBtn" class="btn btn-primary btn-sm" type="button">Configure source</button>
                <button id="refreshSources" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
        </div>
        <div class="stage-body">
            <div id="sourcesTable" class="table-body wide"></div>
            <div class="subsection">
                <h3>Assign existing source</h3>
                <p class="field-hint">Reuse a source or copy it into this dataset.</p>
                <div class="form-group">
                    <label for="existingSourceSelect">Available sources</label>
                    <div class="inline-controls">
                        <select id="existingSourceSelect"></select>
                        <button id="assignSourceBtn" class="btn btn-secondary btn-sm" type="button">Assign</button>
                        <a href="/sources" class="btn btn-ghost btn-sm">Open Sources</a>
                    </div>
                    <p id="assignSourceHint" class="field-hint"></p>
                </div>
            </div>
        </div>
        <div class="stage-footer">
            <button id="startIngestionBtn" class="btn btn-primary">Next: Start ingestion</button>
        </div>
    </section>

    <section class="card stage-section" data-stage-section="mapping" id="mappingStage">
        <div class="card-header">
            <div>
                <h2>Stage 2 ‚Äî Mapping editor</h2>
                <p class="field-hint">Work through mappings directly on this page. Preview raw tables, define fields, and click Next to transform.</p>
            </div>
            <div class="table-actions">
                <button id="inlineSaveMapping" class="btn btn-primary btn-sm">Done</button>
            </div>
        </div>
        <div class="stage-body">
            <div class="mapping-inline">
                <div class="mapping-toolbar">
                    <label for="inlineTableSelector" class="field-hint">Preview tables</label>
                    <div class="mapping-preview-controls">
                        <select id="inlineTableSelector" class="compact-select"></select>
                        <button id="inlineRefreshPreview" class="btn-icon" type="button" aria-label="Refresh preview">‚ü≥</button>
                    </div>
                </div>
                <div id="inlineMappingGrid" class="mapping-grid">Ingest sources to preview raw tables.</div>
            </div>
            <div class="mapping-forms">
                <div class="subsection">
                    <div class="card-header inline">
                        <div>
                            <h3>Unified fields</h3>
                            <p class="field-hint">Add or edit unified fields for the dataset.</p>
                        </div>
                        <div class="table-actions">
                            <button id="addFieldBtn" class="btn btn-secondary btn-sm">+ Field</button>
                        </div>
                    </div>
                    <div id="fieldsTable" class="table-body"></div>
                </div>
                <div class="subsection">
                    <div class="card-header inline">
                        <div>
                            <h3>Mappings</h3>
                            <p class="field-hint">Connect source columns to unified fields.</p>
                        </div>
                        <div class="table-actions">
                            <button id="addMappingBtn" class="btn btn-primary btn-sm">+ Mapping</button>
                        </div>
                    </div>
                    <div id="mappingsTable" class="table-body"></div>
                </div>
            </div>
        </div>
        <div class="stage-footer">
            <button id="startTransformBtn" class="btn btn-primary">Next: Run transformation</button>
        </div>
    </section>

    <section class="card stage-section" data-stage-section="export" id="exportStage">
        <div class="card-header export-header">
            <h2>Export dataset</h2>
            <div class="table-actions">
                <button id="openExportModalBtn" class="btn btn-primary btn-sm" type="button">Export unified dataset</button>
            </div>
        </div>
        <div class="export-summary">
            <div class="summary-item">
                <p class="field-hint">Sources used</p>
                <p id="summarySources" class="summary-value">‚Äî</p>
            </div>
        </div>
        <div class="export-stack">
            <div class="sources-summary">
                <h3>Source(s)</h3>
                <div id="sourcesUsedTable" class="table-body compact"></div>
            </div>
            <div class="unified-table" id="unifiedDataTable">Loading unified data...</div>
        </div>
    </section>
</div>

<!-- Export modal -->
<div id="exportModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2>Export unified dataset</h2>
            <button class="modal-close" id="exportCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
            <p class="field-hint">Choose how you want to export the unified rows for this dataset.</p>
            <div class="form-group">
                <button id="exportCsvBtn" class="btn btn-primary" type="button">Download CSV</button>
            </div>
            <p id="exportStatus" class="field-hint"></p>
        </div>
    </div>
</div>

<!-- Add source modal -->
<div id="addSourceModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2>Create Source</h2>
            <button class="modal-close" onclick="window.datasetDetail.closeAddSourceModal()">√ó</button>
        </div>
        <form id="addSourceForm">
            <div class="modal-body">
                <input type="hidden" id="sourceRole" value="SOURCE">
                <div class="form-group">
                    <label for="sourceName">Name *</label>
                    <input type="text" id="sourceName" required placeholder="e.g., CRM Database">
                </div>

                <div class="form-group">
                        <label for="sourceType">Type *</label>
                        <select id="sourceType" required>
                            <option value="">Select type...</option>
                            <option value="DB">Database</option>
                            <option value="CSV">CSV File</option>
                        </select>
                    </div>

                <div class="form-group" id="dbConfigSection" style="display: none;">
                    <label>Database Configuration</label>
                    <div class="config-grid">
                        <div class="config-field">
                            <label for="dbHost">Host *</label>
                            <input type="text" id="dbHost" placeholder="db.internal">
                        </div>
                        <div class="config-field">
                            <label for="dbPort">Port *</label>
                            <input type="number" id="dbPort" value="5432" min="1">
                        </div>
                        <div class="config-field">
                            <label for="dbName">Database *</label>
                            <input type="text" id="dbName" placeholder="warehouse">
                        </div>
                        <div class="config-field">
                            <label for="dbUser">Username *</label>
                            <input type="text" id="dbUser" placeholder="ingest_bot">
                        </div>
                        <div class="config-field">
                            <label for="dbPassword">Password *</label>
                            <input type="password" id="dbPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button type="button" id="testDbConnection" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;">Test Connection</button>
                    <div id="dbTestResult" class="field-hint"></div>
                </div>

                <div class="form-group" id="fileConfigSection" style="display: none;">
                    <label>File Upload</label>
                    <div id="fileDropzone" class="dropzone" tabindex="0">
                        <span class="dropzone-icon">üìÅ</span>
                        <div class="dropzone-text">
                            <strong>Drop your file here</strong>
                            <span>or click to browse</span>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                    <div id="fileName" class="file-name"></div>
                </div>

                <div class="form-group" id="csvDelimiterSection" style="display: none;">
                    <label for="csvDelimiter">CSV Delimiter</label>
                    <input type="text" id="csvDelimiter" value="," maxlength="5" placeholder=",">
                    <div class="field-hint">Only shown for CSV sources. Default comma.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="window.datasetDetail.closeAddSourceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Source</button>
            </div>
        </form>
    </div>
</div>

<!-- Field modal -->
<div id="fieldModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 id="fieldModalTitle">Add field</h2>
            <button class="modal-close" onclick="window.datasetDetail.closeFieldModal()">√ó</button>
        </div>
        <form id="fieldForm">
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="fieldName" required>
                </div>
                <div class="form-group">
                    <label>Data type</label>
                    <select id="fieldType" required>
                        <option value="STRING">STRING</option>
                        <option value="INTEGER">INTEGER</option>
                        <option value="BOOLEAN">BOOLEAN</option>
                        <option value="FLOAT">FLOAT</option>
                        <option value="DATE">DATE</option>
                    </select>
                </div>
                <div class="form-inline">
                    <label><input type="checkbox" id="fieldRequired"> Required</label>
                    <label><input type="checkbox" id="fieldUnique"> Unique</label>
                </div>
                <div class="form-group">
                    <label>Position</label>
                    <input type="number" id="fieldPosition" min="0" step="1" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="window.datasetDetail.closeFieldModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Mapping modal -->
<div id="mappingModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2>Add mapping</h2>
            <button class="modal-close" onclick="window.datasetDetail.closeMappingModal()">√ó</button>
        </div>
        <form id="mappingForm">
            <div class="modal-body">
                <div class="form-group">
                    <label>Source</label>
                    <select id="mappingSource" required></select>
                </div>
                <div class="form-group">
                    <label>Unified field</label>
                    <select id="mappingField" required></select>
                </div>
                <div class="form-group">
                    <label>Source path / column</label>
                    <input type="text" id="mappingPath" placeholder="e.g. data.name" required>
                </div>
                <div class="form-group">
                    <label>Transform</label>
                    <select id="mappingTransformType">
                        <option value="NONE">None</option>
                        <option value="LOWERCASE">Lowercase</option>
                        <option value="UPPERCASE">Uppercase</option>
                        <option value="TRIM">Trim</option>
                        <option value="INT">Integer</option>
                        <option value="FLOAT">Float</option>
                    </select>
                </div>
                <div class="form-inline">
                    <label><input type="checkbox" id="mappingRequired"> Required</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="window.datasetDetail.closeMappingModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="tableSelectionModal" class="modal-overlay" style="display: none;">
    <div class="modal table-wizard">
        <div class="modal-header">
            <h2>Choose tables for this source</h2>
            <button class="modal-close" id="closeTableSelection">√ó</button>
        </div>
        <div class="modal-body">
            <p class="field-hint" id="tableSelectionHint">Loading tables‚Ä¶</p>
            <div id="tableSelectionList" class="table-wizard-list"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" type="button" id="skipTableSelection">Skip</button>
            <button class="btn btn-primary" type="button" id="saveTableSelection">Save selection</button>
        </div>
    </div>
</div>

<script src="/js/api.js"></script>
<script src="/js/toast.js"></script>
<script src="/js/dataset-detail.js"></script>
</body>
</html>
